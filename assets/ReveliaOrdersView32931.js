import{O as J}from"./OrderFilter32931.js";import{o as L,x as K,c as B,a as W,l as u,i as X,_ as j,r as D,p as Y,b as z,e as k,g as h,f as o,w as s,F as Z,h as f,t as c,n as E,s as A,q as P}from"../index32931.js";import{u as $}from"./order32931.js";import{u as ee,p as te,e as T,s as ae}from"./helpers32931.js";import{f as oe,a as ne,b as re}from"./formatData32931.js";import"./location32931.js";import"./datetime32931.js";import"./attraction32931.js";import"./guide32931.js";const se={props:["filters"],setup(m,l){L(()=>{t.value=!0,i.value={first:0,rows:O.value.rows,sortField:null,sortOrder:null},i.value.page=0});const g=$(),{showLoader:n,hideLoader:p}=ee(),w=K(),b=B(()=>w.submitDialog),r=B(()=>g.responseOrders),v=W(),O=u(),C=u(),e=u(),t=u(!0),i=u(),y=u(0),R=u([]),x=u(),F=u();function S(){t.value=!0,setTimeout(()=>{q()},Math.random()*1e3+250)}const q=async function(){const a=new Map;Object.entries(m.filters).forEach(([d,_])=>{_&&((d=="date_from"||d=="date_to")&&_?a.set(d,re(_)):d=="status"&&_?a.set("order_status",_):d=="attraction"?a.set("attraction_id",_.id):a.set(d,_))}),a.set("page",i.value.page+1),a.set("per_page",i.value.rows),await g.fetchAllReveliaOrders(a).then(()=>{t.value=!1}).catch(d=>{t.value=!1,T(v,d)})},M=a=>{i.value=a,S()},U=a=>{e.value.toggle(a)},H=function(a){const d={course_name:a.course_name,start_at:a.start_at};l.emit("updateFilters",d)},G=async function(){n(),await g.downloadOrderCsv(m.filters.attraction_id).then(()=>{p()}).catch(a=>{p(),T(v,a)})},N=function(a,d){x.value=a,F.value=d;let _="Sei sicuro di voler eliminare questa prenotazione?";w.setDialog("Elimina prenotazione","Elimina","Annulla",_),w.setBtnSubmit(!1),w.setDynamicDialogVisibility(!0)},Q=async function(){const a={order_id:x.value,event_id:F.value};n(),await g.deleteOrder(a).then(()=>{p(),ae(v,{message:"Prenotazione eliminata correttamente",error:!1}),S()}).catch(d=>{p(),T(v,d)})},V=async function(a,d){const _={order_id:a,event_id:d};n(),await g.downloadOrderPDF(_).then(()=>{p()}).catch(I=>{p(),T(v,I)})};return X(b,a=>{a&&Q()}),{dt:O,responseOrders:r,loading:t,totalRecords:y,lazyParams:i,currentOrder:C,op:e,expandedRows:R,loadLazyData:S,toggle:U,openDialog:H,onPage:M,openPDF:V,downloadCsv:G,confirmDelete:N,formatDataAndHourFromUnixTimestamps:oe,formatPrettyDate:ne,prettyPaymentStatus:te}}};const ie={class:"flex justify-content-end mt-4 mb-3"},de={class:"order-table"},le=["href"],ce={key:0},ue=h("br",null,null,-1),_e={class:"uppercase"},me=["href"],pe={key:0},ve={class:"flex justify-content-center"};function fe(m,l,g,n,p,w){const b=D("Button"),r=D("Column"),v=D("Badge"),O=D("DataTable"),C=Y("tooltip");return z(),k(Z,null,[h("div",ie,[o(b,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:l[0]||(l[0]=e=>n.downloadCsv()),disabled:n.responseOrders.total==0},null,8,["disabled"])]),h("div",de,[o(O,{value:n.responseOrders.orders,totalRecords:n.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:n.loading,stripedRows:"",onPage:l[1]||(l[1]=e=>n.onPage(e)),expandedRows:n.expandedRows,"onUpdate:expandedRows":l[2]||(l[2]=e=>n.expandedRows=e)},{empty:s(()=>[f(" Nessuna prenotazione trovata. ")]),expansion:s(e=>[o(O,{value:e.data.events,class:"m-4 mx-4"},{empty:s(()=>[f(" Nessuna prenotazione trovata. ")]),default:s(()=>[o(r,{header:"Data prenotazione"},{body:s(({data:t})=>{var i;return[f(c(n.formatPrettyDate((i=t.date_configuration)==null?void 0:i.date_event)),1)]}),_:1}),o(r,{header:"Cliente"},{body:s(()=>[f(c(e.data.user_name)+" "+c(e.data.user_surname),1),ue,h("span",_e,c(e.data.tax_code),1)]),_:2},1024),o(r,{header:"Telefono"},{body:s(()=>[h("a",{href:"https://api.whatsapp.com/send?phone="+e.data.user_phone,target:"_blank"},c(e.data.user_phone),9,me)]),_:2},1024),o(r,{header:"Cap"},{body:s(()=>[f(c(e.data.user_zip),1)]),_:2},1024),o(r,{header:"Orario visita"},{body:s(({data:t})=>{var i,y;return[f(c((i=t.date_configuration)==null?void 0:i.start_at)+" - "+c((y=t.date_configuration)==null?void 0:y.end_at),1)]}),_:1}),o(r,{header:"Guida"},{body:s(({data:t})=>{var i,y,R,x;return[f(c((y=(i=t.date_configuration)==null?void 0:i.guide)==null?void 0:y.first_name)+" "+c((x=(R=t.date_configuration)==null?void 0:R.guide)==null?void 0:x.last_name),1)]}),_:1}),o(r,{header:"Q.tà"},{body:s(()=>{var t;return[f(c((t=e.data.order_items[0])==null?void 0:t.quantity),1)]}),_:2},1024),o(r,{header:"Prezzo"},{body:s(()=>{var t;return[f(" € "+c((t=e.data.order_items[0])==null?void 0:t.price),1)]}),_:2},1024),o(r,{header:"Stato evento"},{body:s(({data:t})=>[t.status?(z(),k("div",pe,[o(v,{value:n.prettyPaymentStatus(t.status),class:E([t.status,"px-3 border-round-lg"])},null,8,["value","class"])])):A("",!0)]),_:1}),o(r,{header:""},{body:s(({data:t})=>[h("div",ve,[P(o(b,{link:"",icon:"pi pi-print",target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:i=>n.openPDF(e.data.id,t.id)},null,8,["onClick"]),[[C,"Stampa",void 0,{top:!0}]]),P(o(b,{link:"",icon:"pi pi-trash",target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:i=>n.confirmDelete(e.data.id,t.id)},null,8,["onClick"]),[[C,"Elimina",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:s(()=>[o(r,{header:"Codice prenotazione",field:"order_number",ref:"order_number"},null,512),o(r,{header:"Email",field:"user_email",ref:"user_email"},{body:s(({data:e})=>[h("a",{href:"https://mail.google.com/mail/?view=cm&fs=1&tf=1&to="+e.user_email,target:"_blank"},c(e.user_email),9,le)]),_:1},512),o(r,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:s(({data:e})=>[f(c(n.formatDataAndHourFromUnixTimestamps(e.created_at)),1)]),_:1},512),o(r,{header:"Stato pagamento"},{body:s(({data:e})=>[e.status?(z(),k("div",ce,[o(v,{value:n.prettyPaymentStatus(e.status),class:E([e.status,"px-3 border-round-lg"])},null,8,["value","class"])])):A("",!0)]),_:1}),o(r,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const ge=j(se,[["render",fe]]),he={setup(){L(()=>{});const m=u({}),l=u(),g=u(!0);return{form:m,reveliaOrderTable:l,isRevelia:g,filterTable:function(p){m.value=p,m.value.guide&&(m.value.guide_id=m.value.guide.id),l.value.loadLazyData()}}},components:{OrderFilter:J,ReveliaOrderTable:ge}},be=h("h1",null,"Prenotazioni e incassi",-1);function ye(m,l,g,n,p,w){const b=D("OrderFilter"),r=D("ReveliaOrderTable");return z(),k("div",null,[be,o(b,{onOnSubmit:l[0]||(l[0]=v=>n.filterTable(v)),revelia:n.isRevelia},null,8,["revelia"]),o(r,{filters:n.form,ref:"reveliaOrderTable"},null,8,["filters"])])}const Se=j(he,[["render",ye]]);export{Se as default};

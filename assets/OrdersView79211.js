import{u as I}from"./location79211.js";import{D as j}from"./datetime79211.js";import{u as R}from"./order79211.js";import{o as L,l as y,c as V,i as E,_ as z,r as f,b as O,m as q,w as l,f as a,g as r,a as M,p as N,q as $,e as k,F as H,h,t as x,n as A,s as Q,v as G}from"../index79211.js";import{u as J,p as K,e as P}from"./helpers79211.js";import{f as W,a as X,b as F}from"./formatData79211.js";const Y={setup(c,o){L(()=>{s()});const i=y({}),e=I(),g=R(),b=V(()=>e.allLocations),u=V(()=>g.paymentStatus),s=function(){b.value?m():_()},m=function(){i.value.location_id=b.value[0].id;const t=j.local(),n=t.minus({months:1}).startOf("month");i.value.date_from=n.toFormat("dd/LL/yyyy"),i.value.date_to=t.toFormat("dd/LL/yyyy"),i.value.status=null,i.value.code="",i.value.user="",o.emit("onSubmit",i.value)},p=function(){s()},_=async function(){await e.fetchAllLocations()};return E(b,()=>{m()}),{form:i,locations:b,statuses:u,resetForm:p}}},Z={class:"formgrid grid px-0 align-items-center"},ee={class:"field col-3 flex flex-column"},oe=r("label",{for:"typology"},"Location",-1),te={class:"field col-2"},ae=r("label",{from:"date_from"},"Dal",-1),ne={class:"field col-2"},se=r("label",{from:"date_to"},"Al",-1),re={class:"field col-3 flex flex-column"},le=r("label",{from:"status"},"Codice prenotazione",-1),de={class:"field col-3 flex flex-column"},ie=r("label",{from:"status"},"Acquirente",-1),ce={class:"field col-2 flex flex-column"},ue=r("label",{from:"status"},"Stato pagamento",-1),me={class:"flex col-12 justify-content-end pt-1"},fe=r("div",{class:"col-12",style:{color:"red"}}," TODO mancano i filtri per codice prenotazione e acquirente ",-1);function _e(c,o,i,e,g,b){const u=f("Dropdown"),s=f("Calendar"),m=f("InputText"),p=f("Button"),_=f("AccordionTab"),t=f("Accordion");return O(),q(t,{activeIndex:0},{default:l(()=>[a(_,{header:"FILTRI"},{default:l(()=>[r("div",Z,[r("div",ee,[oe,a(u,{modelValue:e.form.location_id,"onUpdate:modelValue":o[0]||(o[0]=n=>e.form.location_id=n),options:e.locations,optionLabel:"name",optionValue:"id",placeholder:""},null,8,["modelValue","options"])]),r("div",te,[ae,a(s,{inputId:"date_from",modelValue:e.form.date_from,"onUpdate:modelValue":o[1]||(o[1]=n=>e.form.date_from=n),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),r("div",ne,[se,a(s,{inputId:"date_to",modelValue:e.form.date_to,"onUpdate:modelValue":o[2]||(o[2]=n=>e.form.date_to=n),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),r("div",re,[le,a(m,{type:"text",modelValue:e.form.code,"onUpdate:modelValue":o[3]||(o[3]=n=>e.form.code=n)},null,8,["modelValue"])]),r("div",de,[ie,a(m,{type:"text",modelValue:e.form.user,"onUpdate:modelValue":o[4]||(o[4]=n=>e.form.user=n)},null,8,["modelValue"])]),r("div",ce,[ue,a(u,{id:"status",modelValue:e.form.status,"onUpdate:modelValue":o[5]||(o[5]=n=>e.form.status=n),options:e.statuses,optionLabel:"name",optionValue:"id",placeholder:""},null,8,["modelValue","options"])])]),r("div",me,[a(p,{label:"Ricerca",class:"mr-2",onClick:o[6]||(o[6]=n=>c.$emit("onSubmit",e.form))}),a(p,{label:"Annulla",class:"p-button-outlined",onClick:o[7]||(o[7]=n=>e.resetForm())})]),fe]),_:1})]),_:1})}const pe=z(Y,[["render",_e]]),ve={props:["filters"],setup(c,o){L(()=>{_.value=!0,t.value={first:0,rows:s.value.rows,sortField:null,sortOrder:null},t.value.page=0});const i=R(),{showLoader:e,hideLoader:g}=J(),b=V(()=>i.responseOrders),u=M(),s=y(),m=y(),p=y(),_=y(!0),t=y(),n=y(0),D=y([]);function S(){_.value=!0,setTimeout(()=>{B()},Math.random()*1e3+250)}const B=async function(){const d=new Map;Object.entries(c.filters).forEach(([v,w])=>{w&&((v=="date_from"||v=="date_to")&&w?d.set(v,F(w)):d.set(v,w))}),d.set("page",t.value.page+1),d.set("per_page",t.value.rows),await i.fetchAllOrders(d).then(()=>{_.value=!1}).catch(v=>{_.value=!1,P(u,v)})};return{dt:s,responseOrders:b,loading:_,totalRecords:n,lazyParams:t,currentOrder:m,op:p,expandedRows:D,loadLazyData:S,toggle:d=>{p.value.toggle(d)},openDialog:function(d){const v={course_name:d.course_name,start_at:d.start_at};o.emit("updateFilters",v)},onPage:d=>{t.value=d,S()},openPDF:function(d){window.open(d,"_blank")},downloadCsv:async function(){let d=c.filters.location_id,v=F(c.filters.date_from),w=F(c.filters.date_to);e();try{const T=await N({method:"get",url:`/admin/locations/${d}/orders?format=csv&date_from=${v}&date_to=${w}`,responseType:"blob"});var U=new Blob([T.data],{type:T.headers["content-type"]});const C=document.createElement("a");C.href=window.URL.createObjectURL(U),C.download="Prenotazioni.csv",C.click(),g()}catch(T){g(),P(u,T)}},formatDataAndHourFromUnixTimestamps:W,formatPrettyDate:X,prettyPaymentStatus:K}}};const ye={class:"flex justify-content-end mt-4 mb-3"},be={class:"order-table"},he={key:0},xe=r("div",{class:"flex justify-content-center w-full"},"PDF",-1),ge={class:"flex justify-content-center"},we={class:"flex justify-content-end"},De={class:"col-3 pl-4"};function Te(c,o,i,e,g,b){const u=f("Button"),s=f("Column"),m=f("Badge"),p=f("DataTable"),_=$("tooltip");return O(),k(H,null,[r("div",ye,[a(u,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:o[0]||(o[0]=t=>e.downloadCsv())})]),r("div",be,[a(p,{value:e.responseOrders.orders,totalRecords:e.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:e.loading,stripedRows:"",onPage:o[1]||(o[1]=t=>e.onPage(t)),expandedRows:e.expandedRows,"onUpdate:expandedRows":o[2]||(o[2]=t=>e.expandedRows=t)},{empty:l(()=>[h(" Nessuna prenotazione trovata. ")]),expansion:l(t=>[a(p,{value:t.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:l(()=>[h(" Nessuna prenotazione trovata. ")]),footer:l(()=>[r("div",we,[r("div",De,"Totale: € "+x((+t.data.total).toFixed(2)),1)])]),default:l(()=>[a(s,{header:"Codice biglietto",field:"ticket"}),a(s,{header:"Tipo biglietto"},{body:l(({data:n})=>[a(m,{value:n.name,class:A([n.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),a(s,{header:"Orario visita"},{body:l(()=>[h(x(t.data.order_items[0].time_slot.start_at),1)]),_:2},1024),a(s,{header:"Quantità"},{body:l(({data:n})=>[h(x(n.quantity),1)]),_:1}),a(s,{header:"Prezzo"},{body:l(({data:n})=>[h(" € "+x((+n.price).toFixed(2)),1)]),_:1}),a(s,{field:"tickets_url"},{header:l(()=>[xe]),body:l(({data:n})=>[r("div",ge,[Q(a(u,{link:"",icon:"pi pi-print",href:n.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:D=>e.openPDF(t.data.tickets_url)},null,8,["href","onClick"]),[[_,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:l(()=>[a(s,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),a(s,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:l(({data:t})=>[h(x(t.user_name)+" "+x(t.user_surname),1)]),_:1},512),a(s,{header:"Email",field:"user_email",ref:"user_email"},null,512),a(s,{header:"Telefono",field:"user_phone"}),a(s,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:l(({data:t})=>{var n,D;return[h(x(e.formatPrettyDate((D=(n=t.order_items[0])==null?void 0:n.time_slot)==null?void 0:D.date)),1)]}),_:1},512),a(s,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:l(({data:t})=>[h(x(e.formatDataAndHourFromUnixTimestamps(t.created_at)),1)]),_:1},512),a(s,{header:"Stato"},{body:l(({data:t})=>[t.status?(O(),k("div",he,[a(m,{value:e.prettyPaymentStatus(t.status),class:A([t.status,"px-3 border-round-lg"])},null,8,["value","class"])])):G("",!0)]),_:1}),a(s,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const Oe=z(ve,[["render",Te]]),Ce={setup(){L(()=>{});const c=y({}),o=y();return{form:c,orderTable:o,filterTable:function(e){c.value=e,o.value.loadLazyData()}}},components:{OrderFilter:pe,OrderTable:Oe}},Fe=r("h1",null,"Prenotazioni e incassi",-1);function Ve(c,o,i,e,g,b){const u=f("OrderFilter"),s=f("OrderTable");return O(),k("div",null,[Fe,a(u,{onOnSubmit:o[0]||(o[0]=m=>e.filterTable(m))}),a(s,{filters:e.form,ref:"orderTable"},null,8,["filters"])])}const Ee=z(Ce,[["render",Ve]]);export{Ee as default};

import{O as H}from"./OrderFilter49393.js";import{o as S,c as M,a as j,l as _,m as E,_ as z,r as u,p as I,b as C,e as k,g as r,f as a,w as s,F as $,h as g,t as h,n as P,q,s as N,v as Q}from"../index49393.js";import{u as G}from"./order49393.js";import{u as J,p as K,e as T}from"./helpers49393.js";import{f as W,a as X,b as O,c as V}from"./formatData49393.js";import{u as Y}from"./location49393.js";import{F as Z}from"./vee-validate.esm49393.js";import{D as U}from"./datetime49393.js";import"./attraction49393.js";const ee={props:["filters"],setup(i,t){S(()=>{l.value=!0,o.value={first:0,rows:n.value.rows,sortField:null,sortOrder:null},o.value.page=0});const v=G(),{showLoader:e,hideLoader:y}=J(),w=M(()=>v.responseOrders),c=j(),n=_(),f=_(),b=_(),l=_(!0),o=_(),m=_(0),D=_([]);function B(){l.value=!0,setTimeout(()=>{A()},Math.random()*1e3+250)}const A=async function(){const d=new Map;Object.entries(i.filters).forEach(([p,x])=>{x&&((p=="date_from"||p=="date_to")&&x?d.set(p,O(x)):p=="location"?d.set("location_id",x.id):d.set(p,x))}),d.set("page",o.value.page+1),d.set("per_page",o.value.rows),await v.fetchAllOrders(d).then(()=>{l.value=!1}).catch(p=>{l.value=!1,T(c,p)})};return{dt:n,responseOrders:w,loading:l,totalRecords:m,lazyParams:o,currentOrder:f,op:b,expandedRows:D,loadLazyData:B,toggle:d=>{b.value.toggle(d)},openDialog:function(d){const p={course_name:d.course_name,start_at:d.start_at};t.emit("updateFilters",p)},onPage:d=>{o.value=d,B()},openPDF:function(d){window.open(d,"_blank")},downloadCsv:async function(){let d=i.filters.location_id,p=O(i.filters.date_from),x=O(i.filters.date_to);e();try{const R=await E({method:"get",url:`/admin/locations/${d}/orders?format=csv&date_from=${p}&date_to=${x}`,responseType:"blob"});var L=new Blob([R.data],{type:R.headers["content-type"]});const F=document.createElement("a");F.href=window.URL.createObjectURL(L),F.download="Prenotazioni.csv",F.click(),y()}catch(R){y(),T(c,R)}},formatDataAndHourFromUnixTimestamps:W,formatPrettyDate:X,prettyPaymentStatus:K}}};const te={class:"flex justify-content-end mt-4 mb-3"},oe={class:"order-table"},ae={key:0},ne=r("div",{class:"flex justify-content-center w-full"},"PDF",-1),re={class:"flex justify-content-center"},le={class:"flex justify-content-end"},se={class:"col-3 pl-4"};function de(i,t,v,e,y,w){const c=u("Button"),n=u("Column"),f=u("Badge"),b=u("DataTable"),l=I("tooltip");return C(),k($,null,[r("div",te,[a(c,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:t[0]||(t[0]=o=>e.downloadCsv())})]),r("div",oe,[a(b,{value:e.responseOrders.orders,totalRecords:e.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:e.loading,stripedRows:"",onPage:t[1]||(t[1]=o=>e.onPage(o)),expandedRows:e.expandedRows,"onUpdate:expandedRows":t[2]||(t[2]=o=>e.expandedRows=o)},{empty:s(()=>[g(" Nessuna prenotazione trovata. ")]),expansion:s(o=>[a(b,{value:o.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:s(()=>[g(" Nessuna prenotazione trovata. ")]),footer:s(()=>[r("div",le,[r("div",se,"Totale: € "+h((+o.data.total).toFixed(2)),1)])]),default:s(()=>[a(n,{header:"Codice biglietto",field:"ticket"}),a(n,{header:"Tipo biglietto"},{body:s(({data:m})=>[a(f,{value:m.name,class:P([m.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),a(n,{header:"Orario visita"},{body:s(()=>[g(h(o.data.order_items[0].time_slot.start_at),1)]),_:2},1024),a(n,{header:"Quantità"},{body:s(({data:m})=>[g(h(m.quantity),1)]),_:1}),a(n,{header:"Prezzo"},{body:s(({data:m})=>[g(" € "+h((+m.price).toFixed(2)),1)]),_:1}),a(n,{field:"tickets_url"},{header:s(()=>[ne]),body:s(({data:m})=>[r("div",re,[q(a(c,{link:"",icon:"pi pi-print",href:m.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:D=>e.openPDF(o.data.tickets_url)},null,8,["href","onClick"]),[[l,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:s(()=>[a(n,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),a(n,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:s(({data:o})=>[g(h(o.user_name)+" "+h(o.user_surname),1)]),_:1},512),a(n,{header:"Email",field:"user_email",ref:"user_email"},null,512),a(n,{header:"Telefono",field:"user_phone"}),a(n,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:s(({data:o})=>{var m,D;return[g(h(e.formatPrettyDate((D=(m=o.order_items[0])==null?void 0:m.time_slot)==null?void 0:D.date)),1)]}),_:1},512),a(n,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:s(({data:o})=>[g(h(e.formatDataAndHourFromUnixTimestamps(o.created_at)),1)]),_:1},512),a(n,{header:"Stato"},{body:s(({data:o})=>[o.status?(C(),k("div",ae,[a(f,{value:e.prettyPaymentStatus(o.status),class:P([o.status,"px-3 border-round-lg"])},null,8,["value","class"])])):N("",!0)]),_:1}),a(n,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const ie=z(ee,[["render",de]]),ce={props:["location"],setup(i,t){S(()=>{e.value.start_date=U.local().startOf("day").toFormat("dd/MM/yyyy HH:mm"),e.value.end_date=U.local().endOf("day").toFormat("dd/MM/yyyy HH:mm"),e.value.created_at="true"});const v=j(),e=_({}),y=Y(),w=function(){const n={from:V(e.value.start_date),to:V(e.value.end_date),location_id:i.location.id,location_permalink:i.location.permalink,created_at:e.value.created_at};c(n)},c=async function(n){await y.downloadReport(n).then(()=>{t.emit("onSubmit")}).catch(f=>{T(v,f)})};return{form:e,onSubmit:w}},components:{Form:Z}},me={class:"formgrid grid mt-3"},ue={class:"field col-6 flex flex-column"},_e=r("label",{from:"start_date"},"Dal",-1),fe={class:"field col-6 flex flex-column"},pe=r("label",{from:"end_date"},"Al",-1),ve={class:"flex flex-wrap gap-3 mt-3"},be={class:"flex align-items-center"},ye=r("label",{for:"vendite",class:"ml-2"},"Report vendite",-1),ge={class:"flex align-items-center"},he=r("label",{for:"prenotazioni",class:"ml-2"},"Report visite",-1),we={class:"flex align-items-center justify-content-end mt-6"};function xe(i,t,v,e,y,w){const c=u("Calendar"),n=u("RadioButton"),f=u("Button"),b=u("Form");return C(),Q(b,{onSubmit:e.onSubmit},{default:s(()=>[r("div",me,[r("div",ue,[_e,a(c,{inputId:"start_date",modelValue:e.form.start_date,"onUpdate:modelValue":t[0]||(t[0]=l=>e.form.start_date=l),dateFormat:"dd/mm/yy",manualInput:!0,showTime:"",hourFormat:"24"},null,8,["modelValue"])]),r("div",fe,[pe,a(c,{inputId:"end_date",modelValue:e.form.end_date,"onUpdate:modelValue":t[1]||(t[1]=l=>e.form.end_date=l),dateFormat:"dd/mm/yy",manualInput:!0,showTime:"",hourFormat:"24"},null,8,["modelValue"])])]),r("div",ve,[r("div",be,[a(n,{modelValue:e.form.created_at,"onUpdate:modelValue":t[2]||(t[2]=l=>e.form.created_at=l),inputId:"vendite",name:"vendite",value:"true"},null,8,["modelValue"]),ye]),r("div",ge,[a(n,{modelValue:e.form.created_at,"onUpdate:modelValue":t[3]||(t[3]=l=>e.form.created_at=l),inputId:"prenotazioni",name:"prenotazioni",value:"false"},null,8,["modelValue"]),he])]),r("div",we,[a(f,{label:"Annulla",text:"",onClick:t[4]||(t[4]=l=>i.$emit("onSubmit"))}),a(f,{label:"Scarica",type:"submit"})])]),_:1},8,["onSubmit"])}const De=z(ce,[["render",xe]]),Re={setup(){S(()=>{});const i=_({}),t=_(),v=_(!1),e=_(!1);return{form:i,orderTable:t,isRevelia:v,visibleDialog:e,filterTable:function(c){i.value=c,t.value.loadLazyData()},onCloseReportDialog:function(){e.value=!1}}},components:{OrderFilter:H,OrderTable:ie,SalesReportsDialog:De}},Ce={class:"flex justify-content-between align-items-center"},Fe=r("h1",null,"Prenotazioni e incassi",-1);function Oe(i,t,v,e,y,w){const c=u("Button"),n=u("SalesReportsDialog"),f=u("Dialog"),b=u("OrderFilter"),l=u("OrderTable");return C(),k("div",null,[r("div",Ce,[Fe,a(c,{label:"Report",link:"",class:"m-0 p-0",icon:"pi pi-download",onClick:t[0]||(t[0]=o=>e.visibleDialog=!0)}),a(f,{visible:e.visibleDialog,"onUpdate:visible":t[2]||(t[2]=o=>e.visibleDialog=o),modal:"",header:"Report",style:{width:"35rem"}},{default:s(()=>[a(n,{onOnSubmit:t[1]||(t[1]=o=>e.onCloseReportDialog()),location:e.form.location},null,8,["location"])]),_:1},8,["visible"])]),a(b,{onOnSubmit:t[3]||(t[3]=o=>e.filterTable(o)),revelia:e.isRevelia},null,8,["revelia"]),a(l,{filters:e.form,ref:"orderTable"},null,8,["filters"])])}const Ie=z(Re,[["render",Oe]]);export{Ie as default};

import{O as M}from"./OrderFilter89187.js";import{o as F,c as U,a as P,l as p,_ as S,r as u,m as A,b as k,e as C,g as l,f as a,w as s,F as j,h as g,t as h,n as V,p as H,q as L,s as E}from"../index89187.js";import{u as q}from"./order89187.js";import{u as N,p as Q,e as R}from"./helpers89187.js";import{f as $,a as G,b as O}from"./formatData89187.js";import{u as J}from"./location89187.js";import{F as K}from"./vee-validate.esm89187.js";import{D as z}from"./datetime89187.js";import"./attraction89187.js";import"./guide89187.js";const W={props:["filters"],setup(v,o){F(()=>{m.value=!0,t.value={first:0,rows:r.value.rows,sortField:null,sortOrder:null},t.value.page=0});const b=q(),{showLoader:e,hideLoader:y}=N(),D=U(()=>b.responseOrders),d=P(),r=p(),c=p(),i=p(),m=p(!0),t=p(),_=p(0),w=p([]);function B(){m.value=!0,setTimeout(()=>{I()},Math.random()*1e3+250)}const T=function(n){Object.entries(v.filters).forEach(([f,x])=>{x&&((f=="date_from"||f=="date_to")&&x?n.set(f,O(x)):f=="location"?n.set("location_id",x.id):f=="code"?n.set("name",x):n.set(f,x))}),n.delete("guide"),n.set("page",t.value.page+1),n.set("per_page",t.value.rows)},I=async function(){const n=new Map;T(n),await b.fetchAllOrders(n).then(()=>{m.value=!1}).catch(f=>{m.value=!1,R(d,f)})};return{dt:r,responseOrders:D,loading:m,totalRecords:_,lazyParams:t,currentOrder:c,op:i,expandedRows:w,loadLazyData:B,toggle:n=>{i.value.toggle(n)},openDialog:function(n){const f={course_name:n.course_name,start_at:n.start_at};o.emit("updateFilters",f)},onPage:n=>{t.value=n,B()},openPDF:function(n){window.open(n,"_blank")},downloadCsv:async function(){const n=new Map;T(n),n.set("format","csv"),e(),await b.downloadOrderCsv(n).then(()=>{y()}).catch(f=>{y(),R(d,f)})},formatDataAndHourFromUnixTimestamps:$,formatPrettyDate:G,prettyPaymentStatus:Q}}};const X={class:"flex justify-content-end mt-4 mb-3"},Y={class:"order-table"},Z=["href"],ee=["href"],te={key:0},oe=l("div",{class:"flex justify-content-center w-full"},"PDF",-1),ae={class:"flex justify-content-center"},ne={class:"flex justify-content-end"},le={class:"col-4 pl-6"};function re(v,o,b,e,y,D){const d=u("Button"),r=u("Column"),c=u("Badge"),i=u("DataTable"),m=A("tooltip");return k(),C(j,null,[l("div",X,[a(d,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:o[0]||(o[0]=t=>e.downloadCsv())})]),l("div",Y,[a(i,{value:e.responseOrders.orders,totalRecords:e.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:e.loading,stripedRows:"",onPage:o[1]||(o[1]=t=>e.onPage(t)),expandedRows:e.expandedRows,"onUpdate:expandedRows":o[2]||(o[2]=t=>e.expandedRows=t)},{empty:s(()=>[g(" Nessuna prenotazione trovata. ")]),expansion:s(t=>[a(i,{value:t.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:s(()=>[g(" Nessuna prenotazione trovata. ")]),footer:s(()=>[l("div",ne,[l("div",le,"Totale: € "+h((+t.data.total).toFixed(2)),1)])]),default:s(()=>[a(r,{header:"Tipo biglietto"},{body:s(({data:_})=>[a(c,{value:_.name,class:V([_.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),a(r,{header:"Orario visita"},{body:s(()=>[g(h(t.data.order_items[0].time_slot.start_at),1)]),_:2},1024),a(r,{header:"Quantità"},{body:s(({data:_})=>[g(h(_.quantity),1)]),_:1}),a(r,{header:"Prezzo"},{body:s(({data:_})=>[g(" € "+h((+_.price).toFixed(2)),1)]),_:1}),a(r,{field:"tickets_url"},{header:s(()=>[oe]),body:s(({data:_})=>[l("div",ae,[H(a(d,{link:"",icon:"pi pi-print",href:_.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:w=>e.openPDF(t.data.tickets_url)},null,8,["href","onClick"]),[[m,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:s(()=>[a(r,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),a(r,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:s(({data:t})=>[g(h(t.user_name)+" "+h(t.user_surname),1)]),_:1},512),a(r,{header:"Email",field:"user_email",ref:"user_email"},{body:s(({data:t})=>[l("a",{href:"https://mail.google.com/mail/?view=cm&fs=1&tf=1&to="+t.user_email,target:"_blank"},h(t.user_email),9,Z)]),_:1},512),a(r,{header:"Telefono",field:"user_phone"},{body:s(({data:t})=>[l("a",{href:"https://api.whatsapp.com/send?phone="+t.user_phone,target:"_blank"},h(t.user_phone),9,ee)]),_:1}),a(r,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:s(({data:t})=>{var _,w;return[g(h(e.formatPrettyDate((w=(_=t.order_items[0])==null?void 0:_.time_slot)==null?void 0:w.date)),1)]}),_:1},512),a(r,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:s(({data:t})=>[g(h(e.formatDataAndHourFromUnixTimestamps(t.created_at)),1)]),_:1},512),a(r,{header:"Stato"},{body:s(({data:t})=>[t.status?(k(),C("div",te,[a(c,{value:e.prettyPaymentStatus(t.status),class:V([t.status,"px-3 border-round-lg"])},null,8,["value","class"])])):L("",!0)]),_:1}),a(r,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const se=S(W,[["render",re]]),de={props:["location"],setup(v,o){F(()=>{e.value.start_date=z.local().startOf("day").toFormat("dd/MM/yyyy"),e.value.end_date=z.local().endOf("day").toFormat("dd/MM/yyyy"),e.value.created_at="true",e.value.start_hour="00:00",e.value.end_hour="23:59"});const b=P(),e=p({}),y=J(),D=function(){let c=O(e.value.start_date)+" "+e.value.start_hour,i=O(e.value.end_date)+" "+e.value.end_hour;const m={from:c,to:i,location_id:v.location.id,location_permalink:v.location.permalink,created_at:e.value.created_at};d(m)},d=async function(c){await y.downloadReport(c).then(()=>{o.emit("onSubmit")}).catch(i=>{R(b,i)})};return{form:e,onSubmit:D,setDefaultIfBlank:function(){(!e.value.start_hour||e.value.start_hour=="")&&(e.value.start_hour="00:00"),(!e.value.end_hour||e.value.end_hour=="")&&(e.value.end_hour="23:59")}}},components:{Form:K}},ie={class:"formgrid grid mt-3"},ue={class:"field col-6 flex flex-column"},ce=l("label",{from:"start_date"},"Dal",-1),me=l("label",{from:"start_hour",class:"mt-3"},"Dalle",-1),_e={class:"field col-6 flex flex-column"},fe=l("label",{from:"end_date"},"Al",-1),pe=l("label",{from:"end_hour",class:"mt-3"},"Alle",-1),ve={class:"flex flex-wrap gap-3 mt-3"},be={class:"flex align-items-center"},he=l("label",{for:"vendite",class:"ml-2"},"Report vendite",-1),ye={class:"flex align-items-center"},ge=l("label",{for:"prenotazioni",class:"ml-2"},"Report visite",-1),De={class:"flex align-items-center justify-content-end mt-6"};function xe(v,o,b,e,y,D){const d=u("Calendar"),r=u("InputMask"),c=u("RadioButton"),i=u("Button"),m=u("Form");return k(),E(m,{onSubmit:e.onSubmit},{default:s(()=>[l("div",ie,[l("div",ue,[ce,a(d,{inputId:"start_date",modelValue:e.form.start_date,"onUpdate:modelValue":o[0]||(o[0]=t=>e.form.start_date=t),dateFormat:"dd/mm/yy",manualInput:!0},null,8,["modelValue"]),me,a(r,{id:"start_hour",modelValue:e.form.start_hour,"onUpdate:modelValue":o[1]||(o[1]=t=>e.form.start_hour=t),mask:"99:99",placeholder:"HH:mm",onBlur:o[2]||(o[2]=t=>e.setDefaultIfBlank())},null,8,["modelValue"])]),l("div",_e,[fe,a(d,{inputId:"end_date",modelValue:e.form.end_date,"onUpdate:modelValue":o[3]||(o[3]=t=>e.form.end_date=t),dateFormat:"dd/mm/yy",manualInput:!0},null,8,["modelValue"]),pe,a(r,{id:"end_hour",modelValue:e.form.end_hour,"onUpdate:modelValue":o[4]||(o[4]=t=>e.form.end_hour=t),mask:"99:99",placeholder:"HH:mm",onBlur:o[5]||(o[5]=t=>e.setDefaultIfBlank())},null,8,["modelValue"])])]),l("div",ve,[l("div",be,[a(c,{modelValue:e.form.created_at,"onUpdate:modelValue":o[6]||(o[6]=t=>e.form.created_at=t),inputId:"vendite",name:"vendite",value:"true"},null,8,["modelValue"]),he]),l("div",ye,[a(c,{modelValue:e.form.created_at,"onUpdate:modelValue":o[7]||(o[7]=t=>e.form.created_at=t),inputId:"prenotazioni",name:"prenotazioni",value:"false"},null,8,["modelValue"]),ge])]),l("div",De,[a(i,{label:"Annulla",text:"",onClick:o[8]||(o[8]=t=>v.$emit("onSubmit"))}),a(i,{label:"Scarica",type:"submit"})])]),_:1},8,["onSubmit"])}const we=S(de,[["render",xe]]),ke={setup(){F(()=>{});const v=p({}),o=p(),b=p(!1),e=p(!1);return{form:v,orderTable:o,isRevelia:b,visibleDialog:e,filterTable:function(d){v.value=d,o.value.loadLazyData()},onCloseReportDialog:function(){e.value=!1}}},components:{OrderFilter:M,OrderTable:se,SalesReportsDialog:we}},Ce={class:"flex justify-content-between align-items-center"},Re=l("h1",null,"Prenotazioni e incassi",-1);function Oe(v,o,b,e,y,D){const d=u("Button"),r=u("SalesReportsDialog"),c=u("Dialog"),i=u("OrderFilter"),m=u("OrderTable");return k(),C("div",null,[l("div",Ce,[Re,a(d,{label:"Report",link:"",class:"m-0 p-0",icon:"pi pi-download",onClick:o[0]||(o[0]=t=>e.visibleDialog=!0)}),a(c,{visible:e.visibleDialog,"onUpdate:visible":o[2]||(o[2]=t=>e.visibleDialog=t),modal:"",header:"Report",style:{width:"35rem"}},{default:s(()=>[a(r,{onOnSubmit:o[1]||(o[1]=t=>e.onCloseReportDialog()),location:e.form.location},null,8,["location"])]),_:1},8,["visible"])]),a(i,{onOnSubmit:o[3]||(o[3]=t=>e.filterTable(t)),revelia:e.isRevelia},null,8,["revelia"]),a(m,{filters:e.form,ref:"orderTable"},null,8,["filters"])])}const qe=S(ke,[["render",Oe]]);export{qe as default};

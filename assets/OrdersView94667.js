import{u as I}from"./location94667.js";import{D as j}from"./datetime94667.js";import{l as E,m as q,o as S,p as y,c as V,i as M,_ as k,r as _,b as T,q as N,w as d,f as a,g as l,a as $,s as G,v as H,e as L,F as Q,h,t as g,n as z,x as J,y as K}from"../index94667.js";import{u as W,p as X,e as P}from"./helpers94667.js";import{f as Y,a as Z,b as F}from"./formatData94667.js";class ee{static async fetchAll(e){const i=e.get("location_id");return e.delete("location_id"),(await E(`/admin/locations/${i}/orders`,e)).data}}const R=q({id:"order",state:()=>({order:{},orders:[],response_orders:{},total_orders:Number,calendar:{},discount:{},response:{}}),getters:{allOrders:n=>n.response_orders.orders,responseOrders:n=>n.response_orders,getTotalOrders:n=>n.response_orders?n.response_orders.total:0,getCurrentOrder:n=>n.order,status:()=>[{name:"Attivo",value:"true"},{name:"Disattivo",value:"false"}],getCalendar:n=>n.calendar,getDiscount:n=>n.discount,paymentStatus:()=>[{id:"to_pay",name:"Da pagare"},{id:"payed",name:"Pagato"},{id:"free",name:"Gratuito"}],paymentModeList:()=>[{label:"Digitale (POS)",id:"credit_card"},{label:"Digitale (Satispay)",id:"satispay"},{label:"Ecommerce",id:"ecommerce"},{label:"Contanti",id:"cash"},{label:"Bonifico",id:"credit_transfer"},{label:"Biglietto a data aperta (voucher)",id:"voucher"}],getDeleteResponse:n=>n.response},actions:{async fetchAllOrders(n){await ee.fetchAll(n).then(e=>this.response_orders=e)}}}),te={setup(n,e){S(()=>{s()});const i=y({}),t=I(),x=R(),b=V(()=>t.allLocations),u=V(()=>x.paymentStatus),s=function(){b.value?m():f()},m=function(){i.value.location_id=b.value[0].id;const o=j.local(),r=o.minus({months:1}).startOf("month");i.value.date_from=r.toFormat("dd/LL/yyyy"),i.value.date_to=o.toFormat("dd/LL/yyyy"),i.value.status=null,i.value.code="",i.value.user="",e.emit("onSubmit",i.value)},p=function(){s()},f=async function(){await t.fetchAllLocations()};return M(b,()=>{m()}),{form:i,locations:b,statuses:u,resetForm:p}}},oe={class:"formgrid grid px-0 align-items-center"},ae={class:"field col-3 flex flex-column"},ne=l("label",{for:"typology"},"Location",-1),re={class:"field col-2"},se=l("label",{from:"date_from"},"Dal",-1),le={class:"field col-2"},de=l("label",{from:"date_to"},"Al",-1),ie={class:"field col-3 flex flex-column"},ce=l("label",{from:"status"},"Codice prenotazione",-1),ue={class:"field col-3 flex flex-column"},me=l("label",{from:"status"},"Acquirente",-1),_e={class:"field col-2 flex flex-column"},fe=l("label",{from:"status"},"Stato pagamento",-1),pe={class:"flex col-12 justify-content-end pt-1"},ve=l("div",{class:"col-12",style:{color:"red"}}," TODO mancano i filtri per codice prenotazione e acquirente ",-1);function ye(n,e,i,t,x,b){const u=_("Dropdown"),s=_("Calendar"),m=_("InputText"),p=_("Button"),f=_("AccordionTab"),o=_("Accordion");return T(),N(o,{activeIndex:0},{default:d(()=>[a(f,{header:"FILTRI"},{default:d(()=>[l("div",oe,[l("div",ae,[ne,a(u,{modelValue:t.form.location_id,"onUpdate:modelValue":e[0]||(e[0]=r=>t.form.location_id=r),options:t.locations,optionLabel:"name",optionValue:"id",placeholder:""},null,8,["modelValue","options"])]),l("div",re,[se,a(s,{inputId:"date_from",modelValue:t.form.date_from,"onUpdate:modelValue":e[1]||(e[1]=r=>t.form.date_from=r),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),l("div",le,[de,a(s,{inputId:"date_to",modelValue:t.form.date_to,"onUpdate:modelValue":e[2]||(e[2]=r=>t.form.date_to=r),dateFormat:"dd/mm/yy",manualInput:!1,placeholder:""},null,8,["modelValue"])]),l("div",ie,[ce,a(m,{type:"text",modelValue:t.form.code,"onUpdate:modelValue":e[3]||(e[3]=r=>t.form.code=r)},null,8,["modelValue"])]),l("div",ue,[me,a(m,{type:"text",modelValue:t.form.user,"onUpdate:modelValue":e[4]||(e[4]=r=>t.form.user=r)},null,8,["modelValue"])]),l("div",_e,[fe,a(u,{id:"status",modelValue:t.form.status,"onUpdate:modelValue":e[5]||(e[5]=r=>t.form.status=r),options:t.statuses,optionLabel:"name",optionValue:"id",placeholder:""},null,8,["modelValue","options"])])]),l("div",pe,[a(p,{label:"Ricerca",class:"mr-2",onClick:e[6]||(e[6]=r=>n.$emit("onSubmit",t.form))}),a(p,{label:"Annulla",class:"p-button-outlined",onClick:e[7]||(e[7]=r=>t.resetForm())})]),ve]),_:1})]),_:1})}const be=k(te,[["render",ye]]),he={props:["filters"],setup(n,e){S(()=>{f.value=!0,o.value={first:0,rows:s.value.rows,sortField:null,sortOrder:null},o.value.page=0});const i=R(),{showLoader:t,hideLoader:x}=W(),b=V(()=>i.responseOrders),u=$(),s=y(),m=y(),p=y(),f=y(!0),o=y(),r=y(0),D=y([]);function A(){f.value=!0,setTimeout(()=>{B()},Math.random()*1e3+250)}const B=async function(){const c=new Map;Object.entries(n.filters).forEach(([v,w])=>{w&&((v=="date_from"||v=="date_to")&&w?c.set(v,F(w)):c.set(v,w))}),c.set("page",o.value.page+1),c.set("per_page",o.value.rows),await i.fetchAllOrders(c).then(()=>{f.value=!1}).catch(v=>{f.value=!1,P(u,v)})};return{dt:s,responseOrders:b,loading:f,totalRecords:r,lazyParams:o,currentOrder:m,op:p,expandedRows:D,loadLazyData:A,toggle:c=>{p.value.toggle(c)},openDialog:function(c){const v={course_name:c.course_name,start_at:c.start_at};e.emit("updateFilters",v)},onPage:c=>{o.value=c,A()},openPDF:function(c){window.open(c,"_blank")},downloadCsv:async function(){let c=n.filters.location_id,v=F(n.filters.date_from),w=F(n.filters.date_to);t();try{const O=await G({method:"get",url:`/admin/locations/${c}/orders?format=csv&date_from=${v}&date_to=${w}`,responseType:"blob"});var U=new Blob([O.data],{type:O.headers["content-type"]});const C=document.createElement("a");C.href=window.URL.createObjectURL(U),C.download="Prenotazioni.csv",C.click(),x()}catch(O){x(),P(u,O)}},formatDataAndHourFromUnixTimestamps:Y,formatPrettyDate:Z,prettyPaymentStatus:X}}};const ge={class:"flex justify-content-end mt-4 mb-3"},xe={class:"order-table"},we={key:0},De=l("div",{class:"flex justify-content-center w-full"},"PDF",-1),Oe={class:"flex justify-content-center"},Te={class:"flex justify-content-end"},Ce={class:"col-3 pl-4"};function Fe(n,e,i,t,x,b){const u=_("Button"),s=_("Column"),m=_("Badge"),p=_("DataTable"),f=H("tooltip");return T(),L(Q,null,[l("div",ge,[a(u,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:e[0]||(e[0]=o=>t.downloadCsv())})]),l("div",xe,[a(p,{value:t.responseOrders.orders,totalRecords:t.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:t.loading,stripedRows:"",onPage:e[1]||(e[1]=o=>t.onPage(o)),expandedRows:t.expandedRows,"onUpdate:expandedRows":e[2]||(e[2]=o=>t.expandedRows=o)},{empty:d(()=>[h(" Nessuna prenotazione trovata. ")]),expansion:d(o=>[a(p,{value:o.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:d(()=>[h(" Nessuna prenotazione trovata. ")]),footer:d(()=>[l("div",Te,[l("div",Ce,"Totale: € "+g((+o.data.total).toFixed(2)),1)])]),default:d(()=>[a(s,{header:"Codice biglietto",field:"ticket"}),a(s,{header:"Tipo biglietto"},{body:d(({data:r})=>[a(m,{value:r.name,class:z([r.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),a(s,{header:"Orario visita"},{body:d(()=>[h(g(o.data.order_items[0].time_slot.start_at),1)]),_:2},1024),a(s,{header:"Quantità"},{body:d(({data:r})=>[h(g(r.quantity),1)]),_:1}),a(s,{header:"Prezzo"},{body:d(({data:r})=>[h(" € "+g((+r.price).toFixed(2)),1)]),_:1}),a(s,{field:"tickets_url"},{header:d(()=>[De]),body:d(({data:r})=>[l("div",Oe,[J(a(u,{link:"",icon:"pi pi-print",href:r.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:D=>t.openPDF(o.data.tickets_url)},null,8,["href","onClick"]),[[f,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:d(()=>[a(s,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),a(s,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:d(({data:o})=>[h(g(o.user_name)+" "+g(o.user_surname),1)]),_:1},512),a(s,{header:"Email",field:"user_email",ref:"user_email"},null,512),a(s,{header:"Telefono",field:"user_phone"}),a(s,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:d(({data:o})=>{var r,D;return[h(g(t.formatPrettyDate((D=(r=o.order_items[0])==null?void 0:r.time_slot)==null?void 0:D.date)),1)]}),_:1},512),a(s,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:d(({data:o})=>[h(g(t.formatDataAndHourFromUnixTimestamps(o.created_at)),1)]),_:1},512),a(s,{header:"Stato"},{body:d(({data:o})=>[o.status?(T(),L("div",we,[a(m,{value:t.prettyPaymentStatus(o.status),class:z([o.status,"px-3 border-round-lg"])},null,8,["value","class"])])):K("",!0)]),_:1}),a(s,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const Ve=k(he,[["render",Fe]]),Le={setup(){S(()=>{});const n=y({}),e=y();return{form:n,orderTable:e,filterTable:function(t){n.value=t,e.value.loadLazyData()}}},components:{OrderFilter:be,OrderTable:Ve}},Se=l("h1",null,"Prenotazioni e incassi",-1);function ke(n,e,i,t,x,b){const u=_("OrderFilter"),s=_("OrderTable");return T(),L("div",null,[Se,a(u,{onOnSubmit:e[0]||(e[0]=m=>t.filterTable(m))}),a(s,{filters:t.form,ref:"orderTable"},null,8,["filters"])])}const Me=k(Le,[["render",ke]]);export{Me as default};

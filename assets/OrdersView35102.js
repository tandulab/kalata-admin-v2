import{O as V}from"./OrderFilter35102.js";import{o as S,c as H,a as $,l as u,m as M,_ as z,r as _,p as E,b as C,e as R,g as i,f as a,w as r,F as I,h as y,t as g,n as P,q,s as N,v as Q}from"../index35102.js";import{u as G}from"./order35102.js";import{u as J,p as K,e as T}from"./helpers35102.js";import{f as W,a as X,b as O,c as j}from"./formatData35102.js";import{u as Y}from"./location35102.js";import{F as Z}from"./vee-validate.esm35102.js";import{D as A}from"./datetime35102.js";import"./attraction35102.js";const ee={props:["filters"],setup(d,o){S(()=>{b.value=!0,t.value={first:0,rows:n.value.rows,sortField:null,sortOrder:null},t.value.page=0});const v=G(),{showLoader:e,hideLoader:w}=J(),h=H(()=>v.responseOrders),l=$(),n=u(),p=u(),m=u(),b=u(!0),t=u(),c=u(0),D=u([]);function B(){b.value=!0,setTimeout(()=>{L()},Math.random()*1e3+250)}const L=async function(){const s=new Map;Object.entries(d.filters).forEach(([f,x])=>{x&&((f=="date_from"||f=="date_to")&&x?s.set(f,O(x)):f=="location"?s.set("location_id",x.id):s.set(f,x))}),s.set("page",t.value.page+1),s.set("per_page",t.value.rows),await v.fetchAllOrders(s).then(()=>{b.value=!1}).catch(f=>{b.value=!1,T(l,f)})};return{dt:n,responseOrders:h,loading:b,totalRecords:c,lazyParams:t,currentOrder:p,op:m,expandedRows:D,loadLazyData:B,toggle:s=>{m.value.toggle(s)},openDialog:function(s){const f={course_name:s.course_name,start_at:s.start_at};o.emit("updateFilters",f)},onPage:s=>{t.value=s,B()},openPDF:function(s){window.open(s,"_blank")},downloadCsv:async function(){let s=d.filters.location_id,f=O(d.filters.date_from),x=O(d.filters.date_to);e();try{const k=await M({method:"get",url:`/admin/locations/${s}/orders?format=csv&date_from=${f}&date_to=${x}`,responseType:"blob"});var U=new Blob([k.data],{type:k.headers["content-type"]});const F=document.createElement("a");F.href=window.URL.createObjectURL(U),F.download="Prenotazioni.csv",F.click(),w()}catch(k){w(),T(l,k)}},formatDataAndHourFromUnixTimestamps:W,formatPrettyDate:X,prettyPaymentStatus:K}}};const te={class:"flex justify-content-end mt-4 mb-3"},oe={class:"order-table"},ae={key:0},ne=i("div",{class:"flex justify-content-center w-full"},"PDF",-1),re={class:"flex justify-content-center"},se={class:"flex justify-content-end"},le={class:"col-3 pl-4"};function ie(d,o,v,e,w,h){const l=_("Button"),n=_("Column"),p=_("Badge"),m=_("DataTable"),b=E("tooltip");return C(),R(I,null,[i("div",te,[a(l,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:o[0]||(o[0]=t=>e.downloadCsv())})]),i("div",oe,[a(m,{value:e.responseOrders.orders,totalRecords:e.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:e.loading,stripedRows:"",onPage:o[1]||(o[1]=t=>e.onPage(t)),expandedRows:e.expandedRows,"onUpdate:expandedRows":o[2]||(o[2]=t=>e.expandedRows=t)},{empty:r(()=>[y(" Nessuna prenotazione trovata. ")]),expansion:r(t=>[a(m,{value:t.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:r(()=>[y(" Nessuna prenotazione trovata. ")]),footer:r(()=>[i("div",se,[i("div",le,"Totale: € "+g((+t.data.total).toFixed(2)),1)])]),default:r(()=>[a(n,{header:"Codice biglietto",field:"ticket"}),a(n,{header:"Tipo biglietto"},{body:r(({data:c})=>[a(p,{value:c.name,class:P([c.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),a(n,{header:"Orario visita"},{body:r(()=>[y(g(t.data.order_items[0].time_slot.start_at),1)]),_:2},1024),a(n,{header:"Quantità"},{body:r(({data:c})=>[y(g(c.quantity),1)]),_:1}),a(n,{header:"Prezzo"},{body:r(({data:c})=>[y(" € "+g((+c.price).toFixed(2)),1)]),_:1}),a(n,{field:"tickets_url"},{header:r(()=>[ne]),body:r(({data:c})=>[y(g(t.data)+" ",1),i("div",re,[q(a(l,{link:"",icon:"pi pi-print",href:c.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:D=>e.openPDF(t.data.tickets_url)},null,8,["href","onClick"]),[[b,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:r(()=>[a(n,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),a(n,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:r(({data:t})=>[y(g(t.user_name)+" "+g(t.user_surname),1)]),_:1},512),a(n,{header:"Email",field:"user_email",ref:"user_email"},null,512),a(n,{header:"Telefono",field:"user_phone"}),a(n,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:r(({data:t})=>{var c,D;return[y(g(e.formatPrettyDate((D=(c=t.order_items[0])==null?void 0:c.time_slot)==null?void 0:D.date)),1)]}),_:1},512),a(n,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:r(({data:t})=>[y(g(e.formatDataAndHourFromUnixTimestamps(t.created_at)),1)]),_:1},512),a(n,{header:"Stato"},{body:r(({data:t})=>[t.status?(C(),R("div",ae,[a(p,{value:e.prettyPaymentStatus(t.status),class:P([t.status,"px-3 border-round-lg"])},null,8,["value","class"])])):N("",!0)]),_:1}),a(n,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const de=z(ee,[["render",ie]]),ce={props:["location_permalink"],setup(d,o){S(()=>{let n=A.now().toFormat("dd/MM/yyyy HH:mm");e.value.start_date=A.local().startOf("day").toFormat("dd/MM/yyyy HH:mm"),e.value.end_date=n});const v=$(),e=u({}),w=Y(),h=function(){const n={from:j(e.value.start_date),to:j(e.value.end_date),location_permalink:d.location_permalink};l(n)},l=async function(n){await w.downloadReport(n).then(()=>{o.emit("onSubmit")}).catch(p=>{T(v,p)})};return{form:e,onSubmit:h}},components:{Form:Z}},me={class:"formgrid grid mt-3"},ue={class:"field col-6 flex flex-column"},_e=i("label",{from:"start_date"},"Dal",-1),fe={class:"field col-6 flex flex-column"},pe=i("label",{from:"end_date"},"Al",-1),ve={class:"flex align-items-center justify-content-end mt-6"};function be(d,o,v,e,w,h){const l=_("Calendar"),n=_("Button"),p=_("Form");return C(),Q(p,{onSubmit:e.onSubmit},{default:r(()=>[i("div",me,[i("div",ue,[_e,a(l,{inputId:"start_date",modelValue:e.form.start_date,"onUpdate:modelValue":o[0]||(o[0]=m=>e.form.start_date=m),dateFormat:"dd/mm/yy",manualInput:!0,showTime:"",hourFormat:"24"},null,8,["modelValue"])]),i("div",fe,[pe,a(l,{inputId:"end_date",modelValue:e.form.end_date,"onUpdate:modelValue":o[1]||(o[1]=m=>e.form.end_date=m),dateFormat:"dd/mm/yy",manualInput:!0,showTime:"",hourFormat:"24"},null,8,["modelValue"])])]),i("div",ve,[a(n,{label:"Annulla",text:"",onClick:o[2]||(o[2]=m=>d.$emit("onSubmit"))}),a(n,{label:"Scarica",type:"submit"})])]),_:1},8,["onSubmit"])}const ye=z(ce,[["render",be]]),ge={setup(){S(()=>{});const d=u({}),o=u(),v=u(!1),e=u(!1);return{form:d,orderTable:o,isRevelia:v,visibleDialog:e,filterTable:function(l){d.value=l,o.value.loadLazyData()},onCloseReportDialog:function(){e.value=!1}}},components:{OrderFilter:V,OrderTable:de,SalesReportsDialog:ye}},we={class:"flex justify-content-between align-items-center"},he=i("h1",null,"Prenotazioni e incassi",-1);function xe(d,o,v,e,w,h){const l=_("Button"),n=_("SalesReportsDialog"),p=_("Dialog"),m=_("OrderFilter"),b=_("OrderTable");return C(),R("div",null,[i("div",we,[he,a(l,{label:"Report vendite",link:"",class:"m-0 p-0",icon:"pi pi-download",onClick:o[0]||(o[0]=t=>e.visibleDialog=!0)}),a(p,{visible:e.visibleDialog,"onUpdate:visible":o[2]||(o[2]=t=>e.visibleDialog=t),modal:"",header:"Report vendite",style:{width:"35rem"}},{default:r(()=>[a(n,{onOnSubmit:o[1]||(o[1]=t=>e.onCloseReportDialog()),location_permalink:e.form.location.permalink},null,8,["location_permalink"])]),_:1},8,["visible"])]),a(m,{onOnSubmit:o[3]||(o[3]=t=>e.filterTable(t)),revelia:e.isRevelia},null,8,["revelia"]),a(b,{filters:e.form,ref:"orderTable"},null,8,["filters"])])}const Le=z(ge,[["render",xe]]);export{Le as default};

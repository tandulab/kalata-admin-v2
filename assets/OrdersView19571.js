import{O as A}from"./OrderFilter19571.js";import{o as S,c as E,a as U,l as i,m as q,_ as B,r as g,p as M,b as k,e as F,g as p,f as t,w as n,F as N,h as u,t as _,n as P,q as V,s as H}from"../index19571.js";import{u as $}from"./order19571.js";import{u as Q,p as G,e as R}from"./helpers19571.js";import{f as I,a as J,b as C}from"./formatData19571.js";import"./location19571.js";import"./datetime19571.js";import"./attraction19571.js";const K={props:["filters"],setup(c,s){S(()=>{f.value=!0,e.value={first:0,rows:o.value.rows,sortField:null,sortOrder:null},e.value.page=0});const v=$(),{showLoader:a,hideLoader:b}=Q(),D=E(()=>v.responseOrders),m=U(),o=i(),y=i(),w=i(),f=i(!0),e=i(),d=i(0),x=i([]);function z(){f.value=!0,setTimeout(()=>{j()},Math.random()*1e3+250)}const j=async function(){const r=new Map;Object.entries(c.filters).forEach(([l,h])=>{h&&((l=="date_from"||l=="date_to")&&h?r.set(l,C(h)):r.set(l,h))}),r.set("page",e.value.page+1),r.set("per_page",e.value.rows),await v.fetchAllOrders(r).then(()=>{f.value=!1}).catch(l=>{f.value=!1,R(m,l)})};return{dt:o,responseOrders:D,loading:f,totalRecords:d,lazyParams:e,currentOrder:y,op:w,expandedRows:x,loadLazyData:z,toggle:r=>{w.value.toggle(r)},openDialog:function(r){const l={course_name:r.course_name,start_at:r.start_at};s.emit("updateFilters",l)},onPage:r=>{e.value=r,z()},openPDF:function(r){window.open(r,"_blank")},downloadCsv:async function(){let r=c.filters.location_id,l=C(c.filters.date_from),h=C(c.filters.date_to);a();try{const O=await q({method:"get",url:`/admin/locations/${r}/orders?format=csv&date_from=${l}&date_to=${h}`,responseType:"blob"});var L=new Blob([O.data],{type:O.headers["content-type"]});const T=document.createElement("a");T.href=window.URL.createObjectURL(L),T.download="Prenotazioni.csv",T.click(),b()}catch(O){b(),R(m,O)}},formatDataAndHourFromUnixTimestamps:I,formatPrettyDate:J,prettyPaymentStatus:G}}};const W={class:"flex justify-content-end mt-4 mb-3"},X={class:"order-table"},Y={key:0},Z=p("div",{class:"flex justify-content-center w-full"},"PDF",-1),ee={class:"flex justify-content-center"},te={class:"flex justify-content-end"},oe={class:"col-3 pl-4"};function ae(c,s,v,a,b,D){const m=g("Button"),o=g("Column"),y=g("Badge"),w=g("DataTable"),f=M("tooltip");return k(),F(N,null,[p("div",W,[t(m,{label:"CSV Prenotazioni",icon:"pi pi-download",rounded:"",outlined:"",onClick:s[0]||(s[0]=e=>a.downloadCsv())})]),p("div",X,[t(w,{value:a.responseOrders.orders,totalRecords:a.responseOrders.total,lazy:!0,paginator:!0,rows:30,ref:"dt",loading:a.loading,stripedRows:"",onPage:s[1]||(s[1]=e=>a.onPage(e)),expandedRows:a.expandedRows,"onUpdate:expandedRows":s[2]||(s[2]=e=>a.expandedRows=e)},{empty:n(()=>[u(" Nessuna prenotazione trovata. ")]),expansion:n(e=>[t(w,{value:e.data.order_items[0].tickets,class:"m-4 mx-4"},{empty:n(()=>[u(" Nessuna prenotazione trovata. ")]),footer:n(()=>[p("div",te,[p("div",oe,"Totale: € "+_((+e.data.total).toFixed(2)),1)])]),default:n(()=>[t(o,{header:"Codice biglietto",field:"ticket"}),t(o,{header:"Tipo biglietto"},{body:n(({data:d})=>[t(y,{value:d.name,class:P([d.name,"px-3 border-round-lg"])},null,8,["value","class"])]),_:1}),t(o,{header:"Orario visita"},{body:n(()=>[u(_(e.data.order_items[0].time_slot.start_at),1)]),_:2},1024),t(o,{header:"Quantità"},{body:n(({data:d})=>[u(_(d.quantity),1)]),_:1}),t(o,{header:"Prezzo"},{body:n(({data:d})=>[u(" € "+_((+d.price).toFixed(2)),1)]),_:1}),t(o,{field:"tickets_url"},{header:n(()=>[Z]),body:n(({data:d})=>[p("div",ee,[V(t(m,{link:"",icon:"pi pi-print",href:d.tickets_url,target:"_blank",style:{color:"var(--surface-400)"},text:"",rounded:"",onClick:x=>a.openPDF(e.data.tickets_url)},null,8,["href","onClick"]),[[f,"Stampa",void 0,{top:!0}]])])]),_:2},1024)]),_:2},1032,["value"])]),default:n(()=>[t(o,{header:"Codice prenotazione",field:"reservation_number",ref:"reservation_number"},null,512),t(o,{header:"Effettuata da",field:"created_by",ref:"created_by"},{body:n(({data:e})=>[u(_(e.user_name)+" "+_(e.user_surname),1)]),_:1},512),t(o,{header:"Email",field:"user_email",ref:"user_email"},null,512),t(o,{header:"Telefono",field:"user_phone"}),t(o,{header:"Data prenotazione",field:"created_at",ref:"created_at"},{body:n(({data:e})=>{var d,x;return[u(_(a.formatPrettyDate((x=(d=e.order_items[0])==null?void 0:d.time_slot)==null?void 0:x.date)),1)]}),_:1},512),t(o,{header:"Data ordine",field:"created_at",ref:"created_at"},{body:n(({data:e})=>[u(_(a.formatDataAndHourFromUnixTimestamps(e.created_at)),1)]),_:1},512),t(o,{header:"Stato"},{body:n(({data:e})=>[e.status?(k(),F("div",Y,[t(y,{value:a.prettyPaymentStatus(e.status),class:P([e.status,"px-3 border-round-lg"])},null,8,["value","class"])])):H("",!0)]),_:1}),t(o,{expander:"",style:{width:"5rem"}})]),_:1},8,["value","totalRecords","loading","expandedRows"])])],64)}const re=B(K,[["render",ae]]),ne={setup(){S(()=>{});const c=i({}),s=i(),v=i(!1);return{form:c,orderTable:s,isRevelia:v,filterTable:function(b){c.value=b,s.value.loadLazyData()}}},components:{OrderFilter:A,OrderTable:re}},se=p("h1",null,"Prenotazioni e incassi",-1);function de(c,s,v,a,b,D){const m=g("OrderFilter"),o=g("OrderTable");return k(),F("div",null,[se,t(m,{onOnSubmit:s[0]||(s[0]=y=>a.filterTable(y)),revelia:a.isRevelia},null,8,["revelia"]),t(o,{filters:a.form,ref:"orderTable"},null,8,["filters"])])}const we=B(ne,[["render",de]]);export{we as default};
